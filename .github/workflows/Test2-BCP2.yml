name: BCP-Trail

on:
  workflow_dispatch:

jobs:
  update-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Azure Login + APIM Extension
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"
        echo "üì¶ Installing APIM extension..."
        az extension add --name apim --yes

    - name: Update Backend URLs (Error-Free XML)
      shell: bash
      env:
        RESOURCE_GROUP: "Dinesh-Test-resource-Group"
        APIM_NAME: "APIM-TESTNGT"
        API_ID: "TestUrl"
        OLD_URL: "http://dinesh.com"
        NEW_URL: "https://dinesh1.com"
      run: |
        set -euo pipefail

        echo "üìå Fetching operations..."
        OP_IDS=$(az apim api operation list \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "[].name" -o tsv)

        for op in $OP_IDS; do
          echo "üîç Processing: $op"

          TMP=$(mktemp)

          echo "üì• Fetching existing policy..."
          az apim api operation policy show \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --output xml > "$TMP"

          if ! grep -q "$OLD_URL" "$TMP"; then
            echo "‚è≠Ô∏è URL not found in policy - skipping"
            rm -f "$TMP"
            continue
          fi

          echo "‚úèÔ∏è Updating URL..."
          sed -i "s|${OLD_URL}|${NEW_URL}|g" "$TMP"

          echo "üöÄ Uploading updated policy..."
          az apim api operation policy update \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --value @"$TMP"

          echo "‚úî Updated Operation: $op"
          rm -f "$TMP"
        done

        echo "üéâ All operations processed successfully!"
