name: BCP-Trail

on:
  workflow_dispatch:

jobs:
  update-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Update Backend URLs
        shell: bash
        env:
          RESOURCE_GROUP: "Dinesh-Test-resource-Group"
          SERVICE_NAME: "dineshapimservice"
          API_NAME: "TestUrl"
          OLD_URL: "http://dinesh.com"
          NEW_URL: "https://dinedh1.com"
        run: |
          set -e

          echo "Fetching operations for API: $API_NAME"

          operations=$(az apim api operation list \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$SERVICE_NAME" \
            --api-id "$API_NAME" \
            --query "[].name" -o tsv)

          echo "Found operations:"
          echo "$operations"

          for op in $operations; do
            echo "Processing operation: $op"

            # Export policy XML
            az apim api operation policy get \
              --resource-group "$RESOURCE_GROUP" \
              --service-name "$SERVICE_NAME" \
              --api-id "$API_NAME" \
              --operation-id "$op" \
              --query "value" -o tsv > policy.xml || true

            if grep -q "$OLD_URL" policy.xml; then
              echo "Updating backend URL in operation: $op"
              sed -i "s|$OLD_URL|$NEW_URL|g" policy.xml

              az apim api operation policy set \
                --resource-group "$RESOURCE_GROUP" \
                --service-name "$SERVICE_NAME" \
                --api-id "$API_NAME" \
                --operation-id "$op" \
                --policy-file policy.xml
            else
              echo "No update required for: $op"
            fi
          done

          echo "Backend update completed successfully."
