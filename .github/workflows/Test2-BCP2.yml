name: BCP-Trail

on:
  workflow_dispatch:

jobs:
  update-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Azure Login
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"
    - name: Update Backend URLs (Safe XML/JSON)
      shell: bash
      env:
        RESOURCE_GROUP: "Dinesh-Test-resource-Group"
        APIM_NAME: "APIM-TESTNGT"
        API_ID: "TestUrl"
        OLD_URL: "http://dinesh.com"
        NEW_URL: "https://dinesh1.com"
        API_VERSION: "2024-05-01"
      run: |
        set -euo pipefail
        echo "üîê Getting subscription ID..."
        SUBS_ID=$(az account show --query id -o tsv)
        echo "üìå Fetching operations list..."
        OP_IDS=$(az apim api operation list \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          -o json | jq -r '.[].name')
        urlencode() {
          local length="${#1}"
          for (( i = 0; i < length; i++ )); do
            local c="${1:i:1}"
            case $c in
              [a-zA-Z0-9.~_-]) printf "$c" ;;
              *) printf '%%%02X' "'$c" ;;
            esac
          done
        }
        for op in $OP_IDS; do
          echo "üîç Processing: $op"
          ENCODED_OP=$(urlencode "$op")
          URI="https://management.azure.com/subscriptions/$SUBS_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME/apis/$API_ID/operations/$ENCODED_OP/policies/policy?api-version=$API_VERSION"
          # Single GET request
          RAW_RESPONSE=$(az rest --method get --uri "$URI" --output tsv 2>/dev/null || true)
          if [[ "$RAW_RESPONSE" == "<"* ]]; then
            echo "üìé XML policy detected"
            POLICY_VALUE="$RAW_RESPONSE"
          else
            echo "üìé JSON policy detected"
            POLICY_VALUE=$(az rest --method get --uri "$URI" -o json | jq -r '.properties.value // empty')
          fi
          if [[ -z "$POLICY_VALUE" ]]; then
            echo "‚ö†Ô∏è Empty policy. Skipping..."
            continue
          fi
          if ! echo "$POLICY_VALUE" | grep -q "$OLD_URL"; then
            echo "‚è≠Ô∏è URL not present. Skipping..."
            continue
          fi
          echo "‚úèÔ∏è Updating URL..."
          UPDATED_POLICY=$(echo "$POLICY_VALUE" | sed "s|${OLD_URL}|${NEW_URL}|g")
          BODY=$(jq -n --arg v "$UPDATED_POLICY" '{properties:{value:$v, format:"rawxml"}}')
          echo "üöÄ Uploading updated policy..."
          az rest --method put --uri "$URI" \
            --headers "Content-Type=application/json" \
            --body "$BODY"
          echo "‚úî Updated Operation: $op"
        done
        echo "üéâ All operations processed successfully!"
