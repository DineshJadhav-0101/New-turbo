name: Update APIM Backend URL

# Trigger the workflow on push or manually
on:
  push:
    branches:
      - main   # or your main branch name
  workflow_dispatch:   # Allows for manual trigger

jobs:
  update-apim-backend-url:
    runs-on: ubuntu-latest

    env:
      # Define environment variables for the resource group, APIM service, old and new backend URLs
      RESOURCE_GROUP: "Dinesh-Test-resource-Group"
      APIM_SERVICE_NAME: "APIM-TESTNG"
      OLD_BACKEND_URL: "https://dinesttest1.com"
      NEW_BACKEND_URL: "https://dinesttest2.com"

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 3: Azure Login using Service Principal
      - name: Azure Login
        run: az login --service-principal --username ${{ secrets.AZURE_CLIENT_ID }} --password ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}

      # Step 4: Get the APIs and Operations in APIM and update the backend URL
          # Step 4: Get the APIs and Operations in APIM and update the backend URL
      - name: Update backend URL for API operations
        run: |
          resource_group="${{ env.RESOURCE_GROUP }}"
          apim_service_name="${{ env.APIM_SERVICE_NAME }}"
          old_backend_url="${{ env.OLD_BACKEND_URL }}"
          new_backend_url="${{ env.NEW_BACKEND_URL }}"

          echo "Resource Group: $resource_group"
          echo "APIM Service Name: $apim_service_name"
          echo "Old Backend URL: $old_backend_url"
          echo "New Backend URL: $new_backend_url"

          apis=$(az apim api list --resource-group "$resource_group" --service-name "$apim_service_name" --query "[].id" -o tsv)

          for api in $apis; do
              operations=$(az apim api operation list --resource-group "$resource_group" --service-name "$apim_service_name" --api-id "$(basename "$api")" --query "[].id" -o tsv)

              for operation in $operations; do
                  operation_details=$(az apim api operation show --resource-group "$resource_group" --service-name "$apim_service_name" --api-id "$(basename "$api")" --operation-id "$(basename "$operation")" -o json)

                  # Check the correct property for the backend URL
                  current_backend_url=$(echo "$operation_details" | jq -r '.request.url')

                  echo "Current backend URL for API: $(basename "$api"), Operation: $(basename "$operation") is $current_backend_url"

                  if [[ "$current_backend_url" == "$old_backend_url" ]]; then
                      echo "Updating backend URL for API: $(basename "$api"), Operation: $(basename "$operation")"

                      # Update the backend URL
                      update_result=$(az apim api operation update \
                          --resource-group "$resource_group" \
                          --service-name "$apim_service_name" \
                          --api-id "$(basename "$api")" \
                          --operation-id "$(basename "$operation")" \
                          --set request.url="$new_backend_url" 2>&1)

                      if [[ $? -ne 0 ]]; then
                          echo "Failed to update backend URL: $update_result"
                      else
                          echo "Successfully updated backend URL for API: $(basename "$api"), Operation: $(basename "$operation")"
                      fi
                  fi
              done
          done
