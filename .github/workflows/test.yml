name: Test-BCP

# Trigger the workflow on push or manually
on:
  workflow_dispatch:   # Allows for manual trigger

jobs:
  update-apim-backend-url:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: "Dinesh-Test-resource-Group"
      APIM_SERVICE_NAME: "APIM-TESTNG"
      OLD_BACKEND_URL: "https://dinesttest1.com"
      NEW_BACKEND_URL: "https://dinesttest2.com"

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 3: Azure Login using Service Principal
      - name: Azure Login
        run: az login --service-principal --username ${{ secrets.AZURE_CLIENT_ID }} --password ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}

      # Step 4: Update backend URL for API operations
      - name: Update backend URL for API operations
        run: |
          resource_group="${{ env.RESOURCE_GROUP }}"
          apim_service_name="${{ env.APIM_SERVICE_NAME }}"
          old_backend_url="${{ env.OLD_BACKEND_URL }}"
          new_backend_url="${{ env.NEW_BACKEND_URL }}"

          echo "Resource Group: $resource_group"
          echo "APIM Service Name: $apim_service_name"
          echo "Old Backend URL: $old_backend_url"
          echo "New Backend URL: $new_backend_url"

          # Check the API-level backend URL
          api_id="echo-api"  # Specify the API ID you want to check
          api_service_url=$(az apim api show --resource-group "$resource_group" --service-name "$apim_service_name" --api-id "$api_id" --query "serviceUrl" -o tsv)

          # Update API-level backend URL if it matches the old URL
          if [[ "$api_service_url" == "$old_backend_url" ]]; then
              echo "Updating backend URL for API: $api_id from $old_backend_url to $new_backend_url"
              az apim api update --resource-group "$resource_group" --service-name "$apim_service_name" --api-id "$api_id" --set serviceUrl="$new_backend_url"
          fi

          # Get all APIs in the APIM instance
          apis=$(az apim api list --resource-group "$resource_group" --service-name "$apim_service_name" --query "[].id" -o tsv)

          # Iterate through each API and its operations
          for api in $apis; do
              operations=$(az apim api operation list --resource-group "$resource_group" --service-name "$apim_service_name" --api-id "$(basename "$api")" --query "[].id" -o tsv)

              # Iterate through each operation
              for operation in $operations; do
                  operation_details=$(az apim api operation show --resource-group "$resource_group" --service-name "$apim_service_name" --api-id "$(basename "$api")" --operation-id "$(basename "$operation")" -o json)

                  # Check the correct property for the backend URL
                  current_backend_url=$(echo "$operation_details" | jq -r '.request.url')  # Adjust this line based on the actual property

                  echo "Current backend URL for API: $(basename "$api"), Operation: $(basename "$operation") is $current_backend_url"

                  # Update the operation's backend URL if it matches the old URL
                  if [[ "$current_backend_url" == "$old_backend_url" ]]; then
                      echo "Updating backend URL for API: $(basename "$api"), Operation: $(basename "$operation") from $old_backend_url to $new_backend_url"
                      az apim api operation update \
                          --resource-group "$resource_group" \
                          --service-name "$apim_service_name" \
                          --api-id "$(basename "$api")" \
                          --operation-id "$(basename "$operation")" \
                          --set request.url="$new_backend_url"
                  fi
              done
          done
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
