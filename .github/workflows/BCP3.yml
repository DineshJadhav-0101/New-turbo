name: APIM-DR

on:
  workflow_dispatch:
    inputs:
      direction:
        description: "Switch direction"
        required: true
        type: choice
        options:
          - prod-to-dr
          - dr-to-prod

jobs:
  switch-backend:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: "Dinesh-Test-resource-Group"
      APIM_NAME: "APIM-TESTNGT"
      API_ID: "TestUrl"
      # üëá Change these to your actual URLs
      PROD_URL: "http://dinesh.com"
      DR_URL: "http://dinesh1.com"
      API_VERSION: "2022-08-01"

    steps:
    - name: Azure Login
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        set -euo pipefail
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"

    - name: DR Switch - Decide FROM and TO URLs
      id: decide
      run: |
        set -euo pipefail

        echo "Direction: ${{ github.event.inputs.direction }}"

        if [ "${{ github.event.inputs.direction }}" = "prod-to-dr" ]; then
          FROM_URL="$PROD_URL"
          TO_URL="$DR_URL"
        else
          FROM_URL="$DR_URL"
          TO_URL="$PROD_URL"
        fi

        echo "FROM_URL=$FROM_URL" >> $GITHUB_OUTPUT
        echo "TO_URL=$TO_URL" >> $GITHUB_OUTPUT

    - name: Update API serviceUrl (HTTPs endpoint)
      env:
        FROM_URL: ${{ steps.decide.outputs.FROM_URL }}
        TO_URL: ${{ steps.decide.outputs.TO_URL }}
      run: |
        set -euo pipefail

        echo "üìå Current API backend URL (serviceUrl)..."
        CURRENT_URL=$(az apim api show \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "serviceUrl" -o tsv)

        echo "Current serviceUrl: $CURRENT_URL"
        echo "Switching FROM: $FROM_URL  TO: $TO_URL"

        if [ "$CURRENT_URL" != "$TO_URL" ]; then
          echo "‚úè Updating API serviceUrl to $TO_URL"
          az apim api update \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --set serviceUrl="$TO_URL"
          echo "‚úî API serviceUrl updated."
        else
          echo "‚úÖ API serviceUrl already set to $TO_URL. Skipping."
        fi

    - name: Update operation policies URLs
      env:
        FROM_URL: ${{ steps.decide.outputs.FROM_URL }}
        TO_URL: ${{ steps.decide.outputs.TO_URL }}
      run: |
        set -euo pipefail

        SUBS_ID=$(az account show --query id -o tsv)

        echo "üìå Fetching all operation IDs..."
        OP_IDS=$(az apim api operation list \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "[].name" -o tsv)

        urlencode() {
          local length="${#1}"
          for (( i = 0; i < length; i++ )); do
            case "${1:i:1}" in
              [a-zA-Z0-9.~_-]) printf "${1:i:1}" ;;
              *) printf '%%%02X' "'${1:i:1}" ;;
            esac
          done
        }

        for op in $OP_IDS; do
          echo "üîç Processing operation: $op"
          ENCODED_OP=$(urlencode "$op")

          POLICY_URI="https://management.azure.com/subscriptions/$SUBS_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME/apis/$API_ID/operations/$ENCODED_OP/policies/policy?api-version=$API_VERSION"

          TMP=$(mktemp)

          echo "üì• Fetching policy XML (if exists)..."
          if ! az rest --method get --uri "$POLICY_URI" --headers Accept=application/xml --output-file "$TMP" >/dev/null 2>&1; then
            echo "‚ö† No policy found for $op. Skipping."
            rm -f "$TMP"
            continue
          fi

          if ! grep -q "$FROM_URL" "$TMP"; then
            echo "‚è≠ FROM_URL not found in $op policy. Skipping."
            rm -f "$TMP"
            continue
          fi

          echo "‚úè Replacing $FROM_URL -> $TO_URL in $op policy..."
          sed -i "s|$FROM_URL|$TO_URL|g" "$TMP"

          echo "üöÄ Uploading updated policy for $op..."
          if ! az rest --method put --uri "$POLICY_URI" --body @"$TMP" >/dev/null 2>&1; then
            echo "‚ö† Failed to update policy for $op"
          else
            echo "‚úî Policy updated for $op"
          fi

          rm -f "$TMP"
        done

        echo "üéâ DR switch complete for API $API_ID."
