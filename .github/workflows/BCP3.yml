name: BCP-3

on:
  workflow_dispatch:

jobs:
  update-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Azure Login
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"

    - name: Force Replace set-backend-service in Operation Policies
      shell: bash
      env:
        RESOURCE_GROUP: "Dinesh-Test-resource-Group"
        APIM_NAME: "APIM-TESTNGT"
        API_ID: "TestUrl"
        OLD_URL: "http://dinesh.com"
        NEW_URL: "http://dinesh1.com"
        API_VERSION: "2022-08-01"
      run: |
        set -euo pipefail
        SUBS_ID=$(az account show --query id -o tsv)

        echo "ðŸ“Œ Fetching all operations..."
        OP_IDS=$(az apim api operation list \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "[].name" -o tsv)

        urlencode() {
          local length="${#1}"
          for (( i = 0; i < length; i++ )); do
            case "${1:i:1}" in
              [a-zA-Z0-9.~_-]) printf "${1:i:1}" ;;
              *) printf '%%%02X' "'${1:i:1}" ;;
            esac
          done
        }

        for op in $OP_IDS; do
          echo "ðŸ” Processing $op"
          ENCODED_OP=$(urlencode "$op")
          POLICY_URI="https://management.azure.com/subscriptions/$SUBS_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME/apis/$API_ID/operations/$ENCODED_OP/policies/policy?api-version=$API_VERSION"

          TMP=$(mktemp)

          echo "ðŸ“¥ Downloading existing XML policy (if exists)"
          if ! az rest --method get --uri "$POLICY_URI" --headers Accept=application/xml --output-file "$TMP" >/dev/null 2>&1; then
            echo "âš  No policy exists for $op â€” Creating fresh one"
            echo "<policies>" > "$TMP"
            echo "  <inbound>" >> "$TMP"
            echo "    <base />" >> "$TMP"
            echo "    <set-backend-service base-url=\"$NEW_URL\" />" >> "$TMP"
            echo "  </inbound>" >> "$TMP"
            echo "  <backend><base /></backend>" >> "$TMP"
            echo "  <outbound><base /></outbound>" >> "$TMP"
            echo "  <on-error><base /></on-error>" >> "$TMP"
            echo "</policies>" >> "$TMP"
          else
            echo "ðŸ§¹ Removing existing <set-backend-service> tag"
            sed -i '/<set-backend-service[^>]*>/d' "$TMP"

            echo "âž• Adding new <set-backend-service base-url> tag"
            # If inbound exists, insert inside it
            if grep -q "<inbound>" "$TMP"; then
              sed -i "/<inbound>/a \    <set-backend-service base-url=\"$NEW_URL\" />" "$TMP"
            else
              # No inbound? add whole inbound block at top
              echo "<policies>" > "$TMP.new"
              echo "  <inbound>" >> "$TMP.new"
              echo "    <base />" >> "$TMP.new"
              echo "    <set-backend-service base-url=\"$NEW_URL\" />" >> "$TMP.new"
              echo "  </inbound>" >> "$TMP.new"
              sed -n '1,${p}' "$TMP" >> "$TMP.new"
              mv "$TMP.new" "$TMP"
            fi
          fi

          echo "ðŸš€ Uploading updated FULL XML for $op"
          if ! az rest --method put --uri "$POLICY_URI" --body @"$TMP" >/dev/null 2>&1; then
            echo "âš  Failed to update $op"
          else
            echo "âœ” Successfully updated $op"
          fi

          rm -f "$TMP"
        done

        echo "ðŸŽ‰ DONE! All operations now use base-url = $NEW_URL"
