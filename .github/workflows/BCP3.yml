name: APIM-DR

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: "Dinesh-Test-resource-Group"
      APIM_NAME: "APIM-TESTNGT"
      API_ID: "TestUrl"
      TEST_URL: "http://dinesh1.com"
      API_VERSION: "2022-08-01"

    steps:
    - name: Azure Login
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"

    - name: Find policy error by forcing upload with full debug output
      run: |
        set -euo pipefail

        echo "ðŸ“Œ Fetching operations..."
        OP_IDS=$(az apim api operation list \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "[].name" -o tsv)

        urlencode() { local s="${1}"; local l=${#s}; for ((i=0;i<l;i++)); do c="${s:i:1}"; [[ "$c" =~ [a-zA-Z0-9.~_-] ]] && printf "$c" || printf '%%%02X' "'$c"; done; }

        for op in $OP_IDS; do
          echo "ðŸ” Testing upload on operation: $op"

          # Fetch existing policy XML (raw)
          TMP=$(mktemp)
          if ! az apim api operation policy show \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --query "value" -o tsv > "$TMP" 2>/dev/null; then
            echo "âš  No existing policy for $op"
            rm -f "$TMP"
            continue
          fi

          # Try to force upload of the same file (no changes)
          echo "ðŸš€ Testing upload (debug mode)..."
          echo "---------------------------------------------"
          echo "Operation: $op"
          echo "---------------------------------------------"

          # IMPORTANT: try uploading same content to see error
          az apim api operation policy update \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --value @"$TMP" --debug

          echo "---------------------------------------------"
          rm -f "$TMP"
        done
