name: APIM-DR

on:
  workflow_dispatch:
    inputs:
      direction:
        description: "Switch direction"
        required: true
        type: choice
        options:
          - prod-to-dr
          - dr-to-prod

jobs:
  switch-backend:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: "Dinesh-Test-resource-Group"
      APIM_NAME: "APIM-TESTNGT"
      API_ID: "TestUrl"

      PROD_URL: "http://dinesh.com"
      DR_URL: "http://dinesh1.com"

    steps:
    - name: Azure Login
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"

    - name: üîß Install APIM Policy Extension
      run: |
        az extension add --name apim --upgrade

    - name: Decide URLs
      id: decide
      run: |
        if [ "${{ github.event.inputs.direction }}" = "prod-to-dr" ]; then
          echo "FROM_URL=http://dinesh.com" >> $GITHUB_OUTPUT
          echo "TO_URL=http://dinesh1.com" >> $GITHUB_OUTPUT
        else
          echo "FROM_URL=http://dinesh1.com" >> $GITHUB_OUTPUT
          echo "TO_URL=http://dinesh.com" >> $GITHUB_OUTPUT
        fi

    - name: üõ† Switch Operation Backend
      env:
        FROM_URL: ${{ steps.decide.outputs.FROM_URL }}
        TO_URL: ${{ steps.decide.outputs.TO_URL }}
      run: |
        set -euo pipefail

        OPS=$(az apim api operation list \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "[].name" -o tsv)

        for op in $OPS; do
          echo "üîç Checking $op"

          TMP=$(mktemp)

          if ! az apim api operation policy show \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --query "value" -o tsv > "$TMP" 2>/dev/null; then
            
            echo "‚ö† No policy: Creating new for $op"
            echo "<policies><inbound><base/><set-backend-service base-url=\"$TO_URL\"/></inbound><backend><base/></backend><outbound><base/></outbound><on-error><base/></on-error></policies>" > "$TMP"
          else
            if grep -q "$FROM_URL" "$TMP"; then
              echo "‚úè Replacing URL in $op..."
              sed -i "s|$FROM_URL|$TO_URL|g" "$TMP"
            else
              echo "‚è≠ Skipping (no match) for $op"
              rm -f "$TMP"
              continue
            fi
          fi

          echo "üöÄ Uploading policy for $op"
          az apim api operation policy update \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --value @"$TMP"

          echo "‚úî Updated $op"
          rm -f "$TMP"
        done

        echo "üéâ DR Switch Complete!"
