name: APIM-DEBUG

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: "Dinesh-Test-resource-Group"
      APIM_NAME: "APIM-TESTNGT"
      API_ID: "TestUrl"
      API_VERSION: "2022-08-01"

    steps:
    - name: Azure Login
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"

    - name: Show upload error for each operation (no modification)
      run: |
        set -euo pipefail
        
        echo "ðŸ“Œ Fetching operations..."
        OPS=$(az apim api operation list \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "[].name" -o tsv)

        for op in $OPS; do
          echo "---------------------------------------------"
          echo "ðŸ” Testing upload for: $op"
          echo "---------------------------------------------"
          
          TMP=$(mktemp)

          # Fetch existing policy (raw XML)
          az apim api operation policy show \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --query "value" -o tsv > "$TMP" || {
              echo "âš  No existing policy for $op"
              continue
          }

          # Try to upload SAME policy back to trigger the error
          echo "ðŸš€ Uploading same policy back (DEBUG MODE)..."
          az apim api operation policy update \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --value @"$TMP" --debug
          
          rm -f "$TMP"
          echo "---------------------------------------------"
        done
