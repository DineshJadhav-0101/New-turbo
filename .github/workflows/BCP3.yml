name: APIM-DR

on:
  workflow_dispatch:
    inputs:
      direction:
        description: "Switch direction"
        required: true
        type: choice
        options:
          - prod-to-dr
          - dr-to-prod

jobs:
  switch-backend:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: "Dinesh-Test-resource-Group"
      APIM_NAME: "APIM-TESTNGT"
      API_ID: "TestUrl"

      PROD_URL: "http://dinesh.com"
      DR_URL: "http://dinesh1.com"
      API_VERSION: "2022-08-01"

    steps:
    - name: Azure Login
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"

    - name: Determine Switch Direction
      id: decide
      run: |
        if [ "${{ github.event.inputs.direction }}" = "prod-to-dr" ]; then
          echo "FROM_URL=$PROD_URL" >> $GITHUB_OUTPUT
          echo "TO_URL=$DR_URL" >> $GITHUB_OUTPUT
        else
          echo "FROM_URL=$DR_URL" >> $GITHUB_OUTPUT
          echo "TO_URL=$PROD_URL" >> $GITHUB_OUTPUT
        fi

    - name: Switch Only Operation Policies
      env:
        FROM_URL: ${{ steps.decide.outputs.FROM_URL }}
        TO_URL: ${{ steps.decide.outputs.TO_URL }}
      run: |
        set -euo pipefail
        SUBS_ID=$(az account show --query id -o tsv)

        echo "üìå Fetching operations for API $API_ID..."
        OP_IDS=$(az apim api operation list \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "[].name" -o tsv)

        urlencode() {
          local s="${1}"
          local l=${#s}
          for ((i=0;i<l;i++)); do
            c="${s:i:1}"
            if [[ "$c" =~ [a-zA-Z0-9.~_-] ]]; then
              printf "%s" "$c"
            else
              printf '%%%02X' "'$c"
            fi
          done
        }

        for op in $OP_IDS; do
          echo "üîç Checking: $op"
          ENCODED_OP=$(urlencode "$op")
          POLICY_URI="https://management.azure.com/subscriptions/$SUBS_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME/apis/$API_ID/operations/$ENCODED_OP/policies/policy?api-version=$API_VERSION"

          TMP=$(mktemp)

          echo "üì• Reading existing policy..."
          if ! az rest --method get --uri "$POLICY_URI" \
              --headers "Accept=application/vnd.ms-azure-apim.policy+xml" \
              --output-file "$TMP" >/dev/null 2>&1; then
            echo "‚ö† No existing policy. Creating new one for $op"
            echo "<policies><inbound><base /><set-backend-service base-url=\"$TO_URL\" /></inbound><backend><base /></backend><outbound><base /></outbound><on-error><base /></on-error></policies>" > "$TMP"
          else
            if ! grep -q "$FROM_URL" "$TMP"; then
              echo "‚è≠ URL not found in $op ‚Äî skip"
              rm -f "$TMP"
              continue
            fi

            echo "‚úè Replacing $FROM_URL ‚Üí $TO_URL"
            sed -i "s|$FROM_URL|$TO_URL|g" "$TMP"

            # FIX IF MISSING FULL XML STRUCTURE
            if ! grep -q "<policies>" "$TMP"; then
              echo "‚ö† Policy invalid ‚Äî rebuilding full XML"
              echo "<policies><inbound><base /><set-backend-service base-url=\"$TO_URL\" /></inbound><backend><base /></backend><outbound><base /></outbound><on-error><base /></on-error></policies>" > "$TMP"
            fi
          fi

          echo "üöÄ Uploading updated policy for $op..."
          echo "üîé POLICY_URI = $POLICY_URI"
          echo "üîé POLICY BODY:"
          cat "$TMP"
          echo "----------------------------------------"

          # DEBUG UPLOAD ‚Äì capture real Azure error
          set +e
          UPLOAD_OUTPUT=$(az rest --method put --uri "$POLICY_URI" \
            --headers "Content-Type=application/vnd.ms-azure-apim.policy+xml" \
            --body @"$TMP" 2>&1)
          STATUS=$?
          set -e

          if [ $STATUS -ne 0 ]; then
            echo "‚ùå FAILED: $op (exit code $STATUS)"
            echo "üî¥ Azure error response:"
            echo "$UPLOAD_OUTPUT"
          else
            echo "‚úî SUCCESS: Updated $op"
          fi

          rm -f "$TMP"
        done

        echo "üéâ DR SWITCH COMPLETE ‚Äî Only per-operation backend updated!"
