name: APIM-DEBUG

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: "Dinesh-Test-resource-Group"
      APIM_NAME: "APIM-TESTNGT"
      API_ID: "TestUrl"

    steps:
    - name: Azure Login
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"

    - name: Show Real APIM Error
      run: |
        OPS=$(az apim api operation list --resource-group "$RESOURCE_GROUP" --service-name "$APIM_NAME" --api-id "$API_ID" --query "[].name" -o tsv)
        for op in $OPS; do
          echo "ðŸ” Testing $op"
          TMP=$(mktemp)
          az apim api operation policy show \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --query "value" -o tsv > "$TMP" 2>/dev/null || continue
          # TRY UPLOAD AND CAPTURE ONLY ERROR
          echo "ðŸš¨ Error from Azure:"
          az apim api operation policy update \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --operation-id "$op" \
            --value @"$TMP" 2>&1 | grep -E "ERROR|BadRequest|Validation|Forbidden|Unsupported|Conflict"
          rm -f "$TMP"
        done
