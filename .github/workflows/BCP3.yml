name: BCP-3

on:
  workflow_dispatch:

jobs:
  update-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Azure Login
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        az login --service-principal \
          --username "$AZURE_CLIENT_ID" \
          --password "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID"

    - name: Update Named Backends + API Backend + Operation Policies
      shell: bash
      env:
        RESOURCE_GROUP: "Dinesh-Test-resource-Group"
        APIM_NAME: "APIM-TESTNGT"
        API_ID: "TestUrl"
        OLD_URL: "http://dinesh.com"
        NEW_URL: "https://dinesh1.com"
        API_VERSION: "2022-08-01"
      run: |
        set -euo pipefail

        SUBS_ID=$(az account show --query id -o tsv)
        echo "üìå Subscription: $SUBS_ID"

        ###############################################################################
        # 1) UPDATE NAMED BACKENDS (APIM ‚Üí Backends blade)
        ###############################################################################
        echo "======================="
        echo "üîß Updating Named Backends"
        echo "======================="

        BACKENDS_URI="https://management.azure.com/subscriptions/$SUBS_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME/backends?api-version=$API_VERSION"

        # Get all backend names (value[].name) without jq
        BACKEND_NAMES=$(az rest --method get --uri "$BACKENDS_URI" --query "value[].name" -o tsv 2>/dev/null || echo "")

        for backend in $BACKEND_NAMES; do
          echo "üîç Backend: $backend"
          B_URI="https://management.azure.com/subscriptions/$SUBS_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME/backends/$backend?api-version=$API_VERSION"

          TMP_BACKEND=$(mktemp)

          # Get backend JSON
          if ! az rest --method get --uri "$B_URI" -o json > "$TMP_BACKEND" 2>/dev/null; then
            echo "‚ö† Could not fetch backend $backend, skipping..."
            rm -f "$TMP_BACKEND"
            continue
          fi

          if ! grep -q "$OLD_URL" "$TMP_BACKEND"; then
            echo "‚è≠ OLD_URL not found in backend $backend, skipping..."
            rm -f "$TMP_BACKEND"
            continue
          fi

          echo "‚úè Replacing URL in backend $backend..."
          sed -i "s|${OLD_URL}|${NEW_URL}|g" "$TMP_BACKEND"

          if ! az rest --method put --uri "$B_URI" --body @"$TMP_BACKEND" >/dev/null 2>&1; then
            echo "‚ö† Failed to update backend $backend"
          else
            echo "‚úî Backend $backend updated"
          fi

          rm -f "$TMP_BACKEND"
        done

        ###############################################################################
        # 2) UPDATE MAIN API BACKEND (serviceUrl)
        ###############################################################################
        echo "======================="
        echo "üåê Updating Main API Backend (serviceUrl)"
        echo "======================="

        CURRENT_URL=$(az apim api show \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "serviceUrl" -o tsv)

        echo "üìå Current API serviceUrl = $CURRENT_URL"

        if [[ "$CURRENT_URL" == "$OLD_URL" ]]; then
          echo "‚úè Updating API serviceUrl to $NEW_URL ..."
          az apim api update \
            --resource-group "$RESOURCE_GROUP" \
            --service-name "$APIM_NAME" \
            --api-id "$API_ID" \
            --set serviceUrl="$NEW_URL"
          echo "‚úî API serviceUrl updated"
        else
          echo "‚è≠ API serviceUrl does not match OLD_URL, skipping main API update"
        fi

        ###############################################################################
        # 3) UPDATE OPERATION POLICIES (set-backend-service base-url etc)
        ###############################################################################
        echo "======================="
        echo "üß© Updating Operation Policies"
        echo "======================="

        OP_IDS=$(az apim api operation list \
          --resource-group "$RESOURCE_GROUP" \
          --service-name "$APIM_NAME" \
          --api-id "$API_ID" \
          --query "[].name" -o tsv)

        urlencode() {
          local length="${#1}"
          for (( i = 0; i < length; i++ )); do
            local c="${1:i:1}"
            case $c in
              [a-zA-Z0-9.~_-]) printf "$c" ;;
              *) printf '%%%02X' "'$c" ;;
            esac
          done
        }

        for op in $OP_IDS; do
          echo "üîç Operation: $op"
          ENCODED_OP=$(urlencode "$op")

          POLICY_URI="https://management.azure.com/subscriptions/$SUBS_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME/apis/$API_ID/operations/$ENCODED_OP/policies/policy?api-version=$API_VERSION"

          TMP_POLICY=$(mktemp)

          echo "üì• Fetching policy for $op..."
          if ! az rest --method get --uri "$POLICY_URI" --headers Accept=application/xml --output-file "$TMP_POLICY" >/dev/null 2>&1; then
            echo "‚ö† No policy exists for $op, skipping..."
            rm -f "$TMP_POLICY"
            continue
          fi

          if ! grep -q "$OLD_URL" "$TMP_POLICY"; then
            echo "‚è≠ OLD_URL not present in $op policy, skipping..."
            rm -f "$TMP_POLICY"
            continue
          fi

          echo "‚úè Replacing URL in policy for $op..."
          sed -i "s|${OLD_URL}|${NEW_URL}|g" "$TMP_POLICY"

          echo "üöÄ Uploading updated policy for $op..."
          if ! az rest --method put --uri "$POLICY_URI" --body @"$TMP_POLICY" >/dev/null 2>&1; then
            echo "‚ö† Failed to update policy for $op"
          else
            echo "‚úî Policy updated for $op"
          fi

          rm -f "$TMP_POLICY"
        done

        echo "======================="
        echo "üéâ All backend references processed!"
        echo "======================="
